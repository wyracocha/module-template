name: "$(Rev:rr)"

# Trigger only on master/main branch and pull requests to master/main
trigger:
  branches:
    include:
      - master
      - main
      - devops-test

pr:
  branches:
    include:
      - master
      - main

pool:
  vmImage: "ubuntu-22.04"

variables:
  - template: ../variables/variables.yaml

stages:
- stage: Security
  jobs:
  - job: configuration
    steps:
    - checkout: self
      clean: "true"
    - script: docker run --tty --rm -v "$PWD/infra:/app" -w /app bridgecrew/checkov --directory /app
      displayName: Checkov
    - script: docker run --tty --rm -v "$PWD/infra:/app" aquasec/tfsec /app
- stage: Validation
  jobs:
  - job: Lint
    steps: 
    - checkout: self
      clean: "true"
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform init
      displayName: Terraform init
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform validate
      displayName: Terraform validate
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform fmt -recursive
      displayName: Terraform fmt
    - script: docker run --rm -v "$PWD/infra:/app" -w /app ghcr.io/terraform-linters/tflint
      displayName: Terraform lint
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: $(System.DefaultWorkingDirectory)/infra
        artifact: infra-$(Build.BuildNumber)
        publishLocation: pipeline

- stage: Plan
  jobs:
  - job: plan
    steps:
    - checkout: self
      clean: "true"
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform init
      displayName: Terraform init
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform plan
      displayName: Terraform plan

- stage: Apply
  jobs:
  - job: Apply
    steps:
    - checkout: self
      clean: "true"
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform init
      displayName: Terraform init
    - script: docker run --rm -v "$PWD/infra:/app" -w /app  hashicorp/terraform apply
      displayName: Terraform plan
- stage: Test
  jobs:
  - job: terratest
    steps:
    - checkout: self
      clean: "true" 
    - script:  docker run -it --rm -v "$PWD/infra:/app" -w /app/test  golang:1.23.0-bookworm go test -v